<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Motorista</title>
    <link rel="stylesheet" href="sportMode.css">
    <link rel="stylesheet" href="sportMode.js">

</head>
<header>
    <div class="modo">
        <input class="tgl tgl-ios" id="cb2" type="checkbox" onclick="verifyCheckbox()" checked />
        <label class="tgl-btn" for="cb2"></label>
        <h2>Modo sport</h2>
    </div>
    <div class="logo">
        <img src="../../../../assets/img/tesla_logo_icon_181279.png" alt="" width="50px">
    </div>
    <div class="hora">
        <span id="hora" class="hora"></span>
    </div>
</header>

<body onload="horario() , exibirBateria() , initBattery() , exibirAutonomia() ,exibirCPU(), simularDados()">
    <div class="divTotal">
        <div class="divEsquerda">
            Telemetria:

            <div class="divTeslaTelemetria">
                <div class="divDianteira">
                    <div class="divRodaDianteiraEsquerda">
                        <div class="divSup" id="eixo1">
                            <img src="../../../../assets/img/eixoTelemetria.png" alt="" class="imgTelemetriaComponente">
                        </div>
                        <div class="divSup" id="freio1">
                            <img src="../../../../assets/img/freioTelemetria.png" alt=""
                                class="imgTelemetriaComponente">
                        </div>
                        <div class="divSup" id="pneu1">
                            <img src="../../../../assets/img/pneuTelemetria.png" alt="" class="imgTelemetriaComponente">
                        </div>
                    </div>
                    <div class="divRodaDianteiraDireita">
                        <div class="divSup" id="eixo2">
                            <img src="../../../../assets/img/eixoTelemetria.png" alt="" class="imgTelemetriaComponente">
                        </div>
                        <div class="divSup" id="freio2">
                            <img src="../../../../assets/img/freioTelemetria.png" alt=""
                                class="imgTelemetriaComponente">
                        </div>
                        <div class="divSup" id="pneu2">
                            <img src="../../../../assets/img/pneuTelemetria.png" alt="" class="imgTelemetriaComponente">
                        </div>
                    </div>
                </div>
                <div class="divTraseira">
                    <div class="divRodaTraseiraEsquerda">
                        <div class="divSup" id="eixo3">
                            <img src="../../../../assets/img/eixoTelemetria.png" alt="" class="imgTelemetriaComponente">
                        </div>
                        <div class="divSup" id="freio3">
                            <img src="../../../../assets/img/freioTelemetria.png" alt=""
                                class="imgTelemetriaComponente">
                        </div>
                        <div class="divSup" id="pneu3">
                            <img src="../../../../assets/img/pneuTelemetria.png" alt="" class="imgTelemetriaComponente">
                        </div>
                    </div>
                    <div class="divRodaTraseiraDireita">
                        <div class="divSup" id="eixo4">
                            <img src="../../../../assets/img/eixoTelemetria.png" alt="" class="imgTelemetriaComponente">
                        </div>
                        <div class="divSup" id="freio4">
                            <img src="../../../../assets/img/freioTelemetria.png" alt=""
                                class="imgTelemetriaComponente">
                        </div>
                        <div class="divSup" id="pneu4">
                            <img src="../../../../assets/img/pneuTelemetria.png" alt="" class="imgTelemetriaComponente">
                        </div>
                    </div>
                </div>
            </div>
            <div class="divLegenda">
                <img src="../../../../assets/img/eixoTelemetria.png" alt="" class="imgResumo">
                Eixo
                <img src="../../../../assets/img/freioTelemetria.png" alt="" class="imgResumo">
                Freio
                <img src="../../../../assets/img/pneuTelemetria.png" alt="" class="imgResumo">
                Pneu
            </div>
        </div>
        <div class="divDireita">
            <div class="divSuperior">
                <div class="divKpi">
                    Autonomia da bateria: <br>
                    2 h 34 min <br><br>
                </div>
                <div class="bateria">
                    <div class="battery__card">
                        <div class="battery__data">
                            <p class="battery__text">Bateria</p>
                            <h1 id="batteryPercentage" class="battery__percentage">
                                20%
                            </h1>

                            <p class="battery__status">
                                Bateria Baixa <i class="ri-plug-line"></i>
                            </p>
                        </div>

                        <div class="battery__pill">
                            <div class="battery__level">
                                <div class="battery__liquid"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="divKpi">
                    <div class="divAux">
                        <div id="stopwatch">Volta 00:00:000</div><br><br>
                        <div id="lastLap">Ultima Volta: -</div>
                    </div>
                </div>
            </div>
            <div class="divInferior">
                <div class="chart">
                    <canvas id="myChart"></canvas>
                </div>
            </div>
        </div>
</body>

</html>

<script src="tela.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>

    function simularDados() {
        const temperaturaEixo = Math.floor(Math.random() * (131 - 100) + 100);
        const temperaturaFreio = Math.floor(Math.random() * 100) + 80;
        const temperaturaPneu = Math.floor(Math.random() * (131 - 100) + 100);

        // Atualize os textos com as temperaturas simuladas e aplique as classes de cor
        document.getElementById("eixo1").innerHTML = `${temperaturaEixo}°C <img src="../../../../assets/img/eixoTelemetria.png" alt="" class="imgTelemetriaComponente"><br>`;
        document.getElementById("eixo2").innerHTML = `${temperaturaEixo}°C <img src="../../../../assets/img/eixoTelemetria.png" alt="" class="imgTelemetriaComponente"><br>`;
        document.getElementById("eixo3").innerHTML = `${temperaturaEixo}°C <img src="../../../../assets/img/eixoTelemetria.png" alt="" class="imgTelemetriaComponente"><br>`;
        document.getElementById("eixo4").innerHTML = `${temperaturaEixo}°C <img src="../../../../assets/img/eixoTelemetria.png" alt="" class="imgTelemetriaComponente"><br>`;

        document.getElementById("freio1").innerHTML = `${temperaturaFreio}°C <img src="../../../../assets/img/freioTelemetria.png" alt="" class="imgTelemetriaComponente"><br>`;
        document.getElementById("freio2").innerHTML = `${temperaturaFreio}°C <img src="../../../../assets/img/freioTelemetria.png" alt="" class="imgTelemetriaComponente"><br>`;
        document.getElementById("freio3").innerHTML = `${temperaturaFreio}°C <img src="../../../../assets/img/freioTelemetria.png" alt="" class="imgTelemetriaComponente"><br>`;
        document.getElementById("freio4").innerHTML = `${temperaturaFreio}°C <img src="../../../../assets/img/freioTelemetria.png" alt="" class="imgTelemetriaComponente"><br>`;

        document.getElementById("pneu1").innerHTML = `${temperaturaPneu}°C <img src="../../../../assets/img/pneuTelemetria.png" alt="" class="imgTelemetriaComponente"><br>`;
        document.getElementById("pneu2").innerHTML = `${temperaturaPneu}°C <img src="../../../../assets/img/pneuTelemetria.png" alt="" class="imgTelemetriaComponente"><br>`;
        document.getElementById("pneu3").innerHTML = `${temperaturaPneu}°C <img src="../../../../assets/img/pneuTelemetria.png" alt="" class="imgTelemetriaComponente"><br>`;
        document.getElementById("pneu4").innerHTML = `${temperaturaPneu}°C <img src="../../../../assets/img/pneuTelemetria.png" alt="" class="imgTelemetriaComponente"><br>`;
    }
    setInterval(simularDados, 2000);

    let isRunning = false;
    let isPaused = false;
    let startTime;
    let interval;
    let lastLapTime = 0;

    function startStopwatch() {
        if (!isRunning && !isPaused) {
            isRunning = true;
            startTime = new Date().getTime();

            interval = setInterval(updateTime, 10);
        }
    }

    function stopStopwatch() {
        if (isRunning) {
            isRunning = false;
            clearInterval(interval);
        }
    }

    function resetStopwatch() {
        isRunning = false;
        isPaused = false;
        clearInterval(interval);
        document.getElementById("stopwatch").innerText = "Volta: 00:00:000";
        lastLapTime = 0;
        updateLastLapDisplay();
    }

    function updateTime() {
        if (!isRunning || isPaused) return;

        const currentTime = new Date().getTime();
        const elapsedTime = currentTime - startTime;

        const minutes = Math.floor(elapsedTime / (60 * 1000));
        const seconds = Math.floor((elapsedTime % (60 * 1000)) / 1000);
        const milliseconds = elapsedTime % 1000;

        const formattedTime =
            padNumber(minutes) + ":" +
            padNumber(seconds) + ":" +
            padNumber(milliseconds, 3);

        document.getElementById("stopwatch").innerText = "Volta:" + formattedTime;
    }

    function lapStopwatch() {
        if (isRunning && !isPaused) {
            const currentTime = new Date().getTime();
            lastLapTime = currentTime - startTime;
            startTime = currentTime; // Reinicia o início do cronômetro
            updateLastLapDisplay();
        } else {
            lastLapTime = 0;
            updateLastLapDisplay();
        }
    }

    function updateLastLapDisplay() {
        const lastLapElement = document.getElementById("lastLap");
        const lastLapText = lastLapTime > 0 ? `Ultima Volta: ${formatTime(lastLapTime)}` : "Ultima Volta: -";
        lastLapElement.innerText = lastLapText;
    }

    function formatTime(time) {
        const minutes = Math.floor(time / (60 * 1000));
        const seconds = Math.floor((time % (60 * 1000)) / 1000);
        const milliseconds = time % 1000;

        return `${padNumber(minutes)}:${padNumber(seconds)}:${padNumber(milliseconds, 3)}`;
    }

    function padNumber(number, width = 2) {
        return number.toString().padStart(width, '0');
    }

    document.addEventListener("keydown", function (event) {
        if (event.key === "7") {
            if (isRunning) {
                lapStopwatch();
            } else {
                startStopwatch();
            }
        } else if (event.key === "8") {
            resetStopwatch();
        } else if (event.key === "9") {
            isPaused = !isPaused;
        }
    });

    function horario() {

        var tempo = new Date();

        document.getElementById("hora").innerHTML = `${tempo.getHours()}:${tempo.getMinutes()}`;

        if (tempo.getMinutes() < 10) {
            document.getElementById("hora").innerHTML = `${tempo.getHours()}:0${tempo.getMinutes()}`;
        }
    }
    setInterval(horario, 10000)


    var arrayTablet = [];

    function exibirAutonomia() {
        fetch(`/tablet/exibirAutonomia`)
            .then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                        console.log(`Dados recebidos autonomia: ${JSON.stringify(resposta)}`);
                        arrayTablet = resposta;
                    });
                } else {
                    console.error("Nenhum dado encontrado ou erro na API");
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ idEmpresa: ${error.message}`);
            });
        return false;
    }

    function exibirCPU() {
        fetch(`/tablet/exibirCPU`)
            .then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                        console.log(`Dados recebidos CPU: ${JSON.stringify(resposta)}`);
                        arrayTablet = resposta;

                        frame1 = arrayTablet[0].cpuUso;

                        // Adicione a chamada para atualizar o gráfico
                        atualizarGrafico(arrayTablet);
                    });
                } else {
                    console.error("Nenhum dado encontrado ou erro na API");
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ idEmpresa: ${error.message}`);
            });
        return false;
        atualizarGrafico();
    } setInterval(exibirCPU, 7000)

    function atualizarGrafico(dados) {
        // Recupere o contexto do canvas onde o gráfico está renderizado
        const ctx = document.getElementById('myChart').getContext('2d');

        // Atualize os dados do gráfico
        meuGrafico.data.labels.push(""); // Adicione um rótulo de tempo (ou use uma abordagem diferente)
        meuGrafico.data.datasets[0].data.push(dados[0].cpuUso);

        // Limita o número de pontos no gráfico, se necessário
        const maxDataPoints = 10;
        if (meuGrafico.data.labels.length > maxDataPoints) {
            meuGrafico.data.labels.shift();
            meuGrafico.data.datasets[0].data.shift();
        }

        // Atualize o gráfico
        meuGrafico.update();
    }

    const ctx = document.getElementById('myChart');
    const meuGrafico = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: '#Consumo em KwH',
                data: [],
                borderWidth: 1,
                borderColor: "red",
                pointBackgroundColor: "red",
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });


    function exibirBateria() {
        fetch(`/tablet/exibirBateria`)
            .then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                        console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                        arrayTablet = resposta;

                        batteryPercentage = arrayTablet[0].bateriaNivel.toString().slice(0, 3)
                        initBattery(batteryPercentage)

                    });
                } else {
                    console.error("Nenhum dado encontrado ou erro na API");
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ idEmpresa: ${error.message}`);
            });
        return false;
    }

    function initBattery() {
        const batteryLiquid = document.querySelector('.battery__liquid'),
            batteryStatus = document.querySelector('.battery__status'),
            batteryHTML = document.querySelector('#batteryPercentage')

        let level = Math.floor(batteryPercentage)
        batteryHTML.innerHTML = level + '%'

        batteryLiquid.style.height = `${parseInt(batteryPercentage)}%`

        if (batteryPercentage == 100) {
            batteryStatus.innerHTML = `Full batterry <i class="ri-battery-2-fill green-color"></i>`
            batteryLiquid.style.height = '103%'
            batteryStatus.style.margin = '35px'
        }
        else if (batteryPercentage <= 20 & !batteryPercentage.charging) {
            batteryStatus.innerHTML = `Low battery <i class="ri-plug-line animated-red"></i>`
            batteryStatus.style.margin = '35px'
        }
        else if (batteryPercentage.charging) {
            batteryStatus.innerHTML = `Charging... <i class="ri-flashlight-line animated-green"></i>`
            batteryStatus.style.margin = '35px'
        }
        else {
            batteryStatus.innerHTML = ''
        }

        if (batteryPercentage <= 20) {
            batteryLiquid.classList.add('gradient-color-red')
            batteryLiquid.classList.remove('gradient-color-orange', 'gradient-color-yellow', 'gradient-color-green')
        }
        else if (batteryPercentage <= 40) {
            batteryLiquid.classList.add('gradient-color-orange')
            batteryLiquid.classList.remove('gradient-color-red', 'gradient-color-yellow', 'gradient-color-green')
        }
        else if (batteryPercentage <= 80) {
            batteryLiquid.classList.add('gradient-color-yellow')
            batteryLiquid.classList.remove('gradient-color-red', 'gradient-color-orange', 'gradient-color-green')
        }
        else {
            batteryLiquid.classList.add('gradient-color-green')
            batteryLiquid.classList.remove('gradient-color-red', 'gradient-color-orange', 'gradient-color-yellow')
        }
    }

    function verifyCheckbox() {
        if (cb2.checked) {
            window.location.href = "../dash-sportMode/sportMode.html";
        } else {
            window.location.href = "../dash-motorista/tela_nova.html";
        }
    }

</script>

<style>
    .verde {
        color: green;
    }

    .amarelo {
        color: yellow;
    }

    .vermelho {
        color: red;
    }
</style>